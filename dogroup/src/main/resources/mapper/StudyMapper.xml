<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dogroup.mybatis.StudyMapper">
	<resultMap id="studyResultMap" 					type="StudyDTO">
		<id property="studyId" 						column="study_id"/>
		<result property="studyTitle" 				column="study_title"/>
		<result property="studySize" 				column="study_size"/>
		<result property="studyFee" 				column="study_fee"/>
		<result property="studyCertification" 		column="study_certification"/>
		<result property="studyDiligenceCutline"	column="study_diligence_cutline"/>
		<result property="studyPostDate"			column="study_post_date"/>
		<result property="studyStartDate" 			column="study_start_date"/>
		<result property="studyEndDate"				column="study_end_date"/>
		<result property="studyHomeworkPerWeek" 	column="study_homework_per_week"/>
		<result property="studyPaid"				column="study_paid"/>
		<result property="studyGatheredSize" 		column="study_gathered_size"/>
		<result property="studyContent"				column="study_content"		jdbcType="CLOB"		javaType="java.lang.String"/>
		<!--스터디장-->
		<association property="studyLeader" 		javaType="UserDTO">
			<result property="email" 				column="user_email"/>
			<result property="name" 				column="user_name"/>
			<result property="diligence"			column="user_diligence"/>
		</association>
		<!--과목 리스트-->
		<collection property="subjects" 			ofType="StudySubjectDTO">
			<result property="studyId"				column="study_id"/>
			<!--과목-->
			<association property="subject" 		javaType="SubjectDTO">
				<result property="subjectCode" 		column="subject_code"/>
				<result property="subjectName" 		column="subject_name"/>
				<!--부모과목-->
				<association property="subjectParent" 		javaType="SubjectDTO">
					<result property="subjectCode" 		column="subject_parent_code"/>
				</association>
			</association>
		</collection>
		<!--스터디원 리스트-->
		<collection property="studyUsers" 			ofType="StudyUserDTO">
			<result property="studyId"				column="study_id"/>
			<!--숙제 리스트-->
			<collection property="homeworkList" 	ofType="HomeworkDTO">
				<result property="userEmail" 		column="user_email"/>
				<result property="studySubmitDt" 	column="study_submit_dt"/>
			</collection>
		</collection>
	</resultMap>

	<!--회원에게 스터디 종료에 따른 금액을 환급한다.-->
	<update id="refundToUser" statementType="CALLABLE" parameterType="hashmap">
		{ CALL proc_wallet_prize (
			#{email},
			#{prize},
			#{studyId}
		)}
	</update>
	
	<!--회원의 성실도를 반영한다. (스터디 종료 성실도 결과 반영)-->
	<update id="setUserDeligence" parameterType="StudyUserDTO">
		UPDATE
			users 
		SET 
			user_diligence = #{diligence}
		WHERE
			user_email = #{email}
	</update>
	
	<!--회원의 성실도를 반환한다.-->
	<select id="searchUserDeligence" parameterType="String" resultType="int">
		SELECT
			user_diligence
		FROM 
			users
		WHERE user_email = #{email}
	</select>

<select id = "selectStudyUsersByStudyId" resultType = "StudyUserDTO" parameterType="int">
	SELECT * 
	FROM study_users 
	JOIN users 
	USING (user_email) 
	WHERE study_id = #{studyId}
</select>

<insert id= "insertHomeworkByEmail"  parameterType="map">

	INSERT 
	INTO 
	HOMEWORK 
	VALUES(sysdate, #{studyId}, #{email})
	


</insert>

</mapper>